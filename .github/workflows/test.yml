name: Test GLaDOS TTS Server
permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '.github/**'
      - '.vscode/**'
      - 'docker/**'
      - 'GitReleaseManager.yaml'
      - '**/*.md'
      - 'renovate.json'

jobs:
  test-and-lint:
    name: "Run pytest and ruff"
    runs-on: self-hosted
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Ruff Linter (Auto-Fix Imports)
        run: ruff check --fix --select I --unsafe-fixes --output-format=github .

      - name: Run Ruff Formatter (Auto-Fix)
        run: ruff format .

      - name: Commit Ruff Fixes
        if: always()
        run: |
          if ! git diff --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -u
            git commit -m "chore(ci): auto-fix ruff formatting + imports"
            git push origin HEAD:${{ github.head_ref }}
          fi

      - name: Run Ruff Formatter Check
        run: ruff format --check .

      - name: Run Pytest
        run: pytest --verbose --cov=server --cov-report=term --cov-report=xml

      - name: Upload coverage.xml as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

      - name: Post Coverage Summary to PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const xml = fs.readFileSync('coverage.xml', 'utf8');

            const lines = xml.split('\n');
            let coverage = null;
            for (const line of lines) {
              if (line.includes('line-rate=')) {
                const match = line.match(/line-rate="([0-9.]+)"/);
                if (match) coverage = (parseFloat(match[1]) * 100).toFixed(2);
              }
            }

            if (!coverage) coverage = "Unknown";

            const body = `
            ## ðŸ§ª Test Coverage Report  
            **Total Coverage:** ${coverage}%  
            Artifact: **coverage-report**
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });


  test_linux:
    needs: test-and-lint
    name: "Build and Test on Linux (self-hosted runner)"
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install GCC and G++
        run: |
          sudo apt update
          sudo apt install -y gcc g++

      - name: Install Netcat
        run: sudo apt-get install -y netcat-openbsd

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Python Virtual Environment Package
        run: pip install virtualenv

      - name: Install Nvidia Drivers
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get install -y nvidia-open

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.29
        with:
          use-github-cache: false
      
      - name: Setup Virtual Environment
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          python3 download.py
          pip install -r requirements.txt

      - name: Start GLaDOS TTS Server and Test Listening
        run: |
          source .venv/bin/activate
          nohup python3 __main__.py --uri 'tcp://0.0.0.0:10201' --debug --streaming > server.log 2>&1 &
          SERVER_PID=$!
          echo "Started GLaDOS TTS server with PID $SERVER_PID"

          function is_server_listening() {
            nc -z localhost 10201
          }

          TIMEOUT=600
          INTERVAL=10
          ELAPSED=0

          while ! is_server_listening; do
            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "Server failed to start within $TIMEOUT seconds."
              kill $SERVER_PID
              exit 1
            fi
            echo "Waiting for server to start... ($ELAPSED/$TIMEOUT seconds elapsed)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

          echo "Server is successfully listening on port 10201."
          kill $SERVER_PID
          wait $SERVER_PID 2>/dev/null || true
          exit 0

      - name: Upload Server Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs
          path: server.log

      - name: CUDA Driver/Library Mismatch Auto-Fix
        if: ${{ failure() }}
        run: |
          echo "Scanning server.log for NVML initialization failure..."
          if grep -Fq "Failed to initialize NVML: Driver/library version mismatch" server.log; then
            echo "CUDA driver/library mismatch detectedâ€”upgrading system and rebooting."
            sudo apt update
            sudo apt upgrade -y
            sudo reboot
          else
            echo "No NVML mismatch found; skipping auto-fix."
          fi
